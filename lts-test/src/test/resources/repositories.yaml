bom: com.google.cloud:gcp-lts-bom:0.1.0-SNAPSHOT
# Useful build parameters:
#   Maven:
#     "-DtrimStackTrace=false" to show stacktrace in the error
#     "-B -ntp" to hide unnecessary download progress
#   Gradle:
#     "--scan" to examine test failures in browsers
#     "--continue" to see all failures among multiple subprojects
repositories:
  - name: beam
    url: https://github.com/apache/beam.git
    # This is a branch, not a tag. But it works
    tag: release-2.30.0
    modification: Gradle
    commands: |
      if [ "$CI" == true ]; then
        # Beam's net.linguica.gradle.maven.settings plugin cannot work with GitHub Actions' default
        # Maven settings.xml file. The variable CI tells whether it's in GitHub Actions or not.
        # https://docs.github.com/en/actions/reference/environment-variables#default-environment-variables
        rm ~/.m2/settings.xml
      fi
      # In Beam, some integration tests that require credentials are misclassified as tests
      # https://issues.apache.org/jira/browse/BEAM-11363?focusedCommentId=17242773&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17242773
      rm ./sdks/java/io/google-cloud-platform/src/test/java/org/apache/beam/sdk/io/gcp/healthcare/{DicomIOTest,FhirIOTest,HL7v2IOTest}.java
      ./gradlew --scan --console=plain -PdisableSpotlessCheck=true --continue \
          :sdks:java:core:check \
          :sdks:java:io:google-cloud-platform:check \
          :sdks:java:extensions:google-cloud-platform-core:check \
          :runners:google-cloud-dataflow-java:check \
           -x analyzeClassesDependencies
  - name: google-api-java-client
    url: https://github.com/googleapis/google-api-java-client.git
    tag: v1.31.3
    modification: Maven
    commands: |
      mkdir /tmp/foo && cd /tmp/foo
      wget https://dl.google.com/dl/android/maven2/com/google/android/gms/play-services-basement/8.3.0/play-services-basement-8.3.0.aar
      unzip play-services-basement-8.3.0.aar
      mvn install:install-file \
          -Dfile=classes.jar \
          -DgroupId=com.google.android.google-play-services \
          -DartifactId=google-play-services \
          -Dversion=1 \
          -Dpackaging=jar
      cd -
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: google-auth-library-java
    url: https://github.com/googleapis/google-auth-library-java.git
    tag: v0.25.2
    modification: Maven
    # appengine module doesn't work
    # https://github.com/GoogleCloudPlatform/cloud-opensource-java/issues/1974#issuecomment-806153876
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -pl oauth2_http,credentials \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: google-http-java-client
    url: https://github.com/googleapis/google-http-java-client.git
    tag: v1.39.1
    modification: Maven
    # google-http-client-appengine does not work with the latest appengine-client-1.0-sdk
    # but the module is not part of the BOM.
    # https://github.com/GoogleCloudPlatform/cloud-opensource-java/issues/1974#issuecomment-805000604
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -pl google-http-client \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: google-maps-services-java
    url: https://github.com/googlemaps/google-maps-services-java.git
    tag: v0.18.0
    modification: Gradle
    commands: |
      perl -i -p -e 's/mavenCentral\(\)/mavenCentral\(\)\nmavenLocal\(\)/;' build.gradle
      ./gradlew --scan --info --console=plain --continue test
  - name: google-oauth-java-client
    url: https://github.com/googleapis/google-oauth-java-client.git
    tag: v1.31.4
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: grpc-java
    url: https://github.com/grpc/grpc-java.git
    tag: v1.37.0
    modification: Gradle
    # :grpc-netty:check, :grpc-okhttp:check do not work on suztomo's Mac
    commands: |
      echo "skipCodegen=true" >> gradle.properties
      echo "skipAndroid=true" >> gradle.properties

      # An assertion on auth test didn't work with the google-auth-library 0.25.X
      # https://github.com/grpc/grpc-java/issues/8037 (fixed in HEAD)
      rm ./auth/src/test/java/io/grpc/auth/GoogleAuthLibraryCallCredentialsTest.java
      ./gradlew --scan --console=plain --continue \
          :grpc-alts:check \
          :grpc-api:check \
          :grpc-auth:check \
          :grpc-context:check \
          :grpc-core:check \
          :grpc-grpclb:check \
          :grpc-okhttp:check \
          :grpc-protobuf:check \
          :grpc-services:check \
          :grpc-stub:check \
          :grpc-testing:check
  - name: java-bigquery
    url: https://github.com/googleapis/java-bigquery.git
    tag: v1.127.11
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: java-bigtable-hbase
    url: https://github.com/googleapis/java-bigtable-hbase.git
    # The repository will undergo overhaul. No need to investigate current v1 branch
    tag: v1.19.1
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress verify \
          --projects bigtable-dataflow-parent/bigtable-hbase-beam \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true
  - name: java-monitoring
    url: https://github.com/googleapis/java-monitoring.git
    tag: v2.1.0
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: java-pubsub
    url: https://github.com/googleapis/java-pubsub.git
    tag: v1.112.0
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: java-spanner
    url: https://github.com/googleapis/java-spanner.git
    tag: v6.0.0
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: java-storage
    url: https://github.com/googleapis/java-storage.git
    tag: v1.113.14
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
  - name: java-trace
    url: https://github.com/googleapis/java-trace.git
    tag: v1.3.0-sp.1
    modification: Maven
    commands: |
      mvn --batch-mode --show-version --no-transfer-progress test \
          -DtrimStackTrace=false \
          -Dclirr.skip=true \
          -Denforcer.skip=true \
          -Dmaven.javadoc.skip=true \
          -Dgcloud.download.skip=true \
          -T 1C
